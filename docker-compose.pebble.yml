services:
  pebble:
    image: ghcr.io/letsencrypt/pebble:latest
    ports:
      - "14000:14000"   # ACME directory  →  https://localhost:14000/dir
      - "15000:15000"   # Management API  →  https://localhost:15000
    environment:
      # Skip the artificial sleep between validation retries
      PEBBLE_VA_NOSLEEP: "1"
      # Auto-approve all HTTP-01 challenges without making real HTTP requests.
      # This lets the full agent flow run without DNS or port-80 access.
      PEBBLE_VA_ALWAYS_VALID: "1"
    # Pebble's built-in test certs & config are bundled in the image.
    # No volume mounts needed for the default configuration.

  acme-test:
    build:
      context: .
      target: test
    environment:
      # Tell conftest.py to reach Pebble by its compose service name instead of localhost
      PEBBLE_HOST: pebble
      CA_PROVIDER: custom
      ACME_DIRECTORY_URL: https://pebble:14000/dir
      ACME_INSECURE: "true"
      MANAGED_DOMAINS: acme-test.localhost
      HTTP_CHALLENGE_MODE: webroot
      WEBROOT_PATH: /tmp/pebble-webroot
      CERT_STORE_PATH: /tmp/pebble-certs
      ACCOUNT_KEY_PATH: /tmp/pebble-account.key
      ANTHROPIC_API_KEY: dummy-key-for-testing
      MAX_RETRIES: "2"
    depends_on:
      - pebble
